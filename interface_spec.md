# ロボット通信インターフェース仕様書

本ドキュメントは、ロボット（RT-StackChan/ESP32側）の実装者向けの通信仕様書です。

## 1. 通信方式

- **プロトコル**: TCP / IP
- **トランスポート層**: Socket通信
- **データ形式**: JSON (Line-delimited / 改行区切り)
- **文字コード**: UTF-8

### 接続構成
- **ロボット側**: TCP Server
    - 固定IPアドレスの割り当てを推奨します。
    - 待受ポート番号（例: 9999）を開放してください。
- **コントローラー側**: TCP Client
    - コントローラーからロボットへ接続要求を行います。

## 2. データフォーマット

データはJSON形式のテキストで送信され、末尾に改行コード `\n` (LF) が付与されます。
受信側は `\n` を検出するまでバッファリングし、1行ごとにJSONとしてパースしてください。

基本構造:
```json
{"cmd": "コマンド種別", "パラメータ": 値 ...}
```

## 3. コマンド一覧

### 3.1. 首振り制御 (Move)

パン（左右/Yaw）・チルト（上下/Pitch）の目標角度を指定します。

- **送信JSON例**:
```json
{"cmd": "move", "pan": 15.5, "tilt": -10.0}
```

- **パラメータ詳細**:
    - `cmd`: `"move"` (固定)
    - `pan`: 左右角度 (float)。正の値で左、負の値で右（実装依存ですが、標準的な座標系を推奨）。
    - `tilt`: 上下角度 (float)。正の値で上、負の値で下。

### 3.2. 表情変更 (Face)

ロボットのディスプレイに表示する表情を指定します。

- **送信JSON例**:
```json
{"cmd": "face", "val": "happy"}
```

- **パラメータ詳細**:
    - `cmd`: `"face"` (固定)
    - `val`: 表情ID (string)。以下のいずれか。
        - `"happy"` (喜)
        - `"sad"` (哀)
        - `"angry"` (怒)
        - `"sleepy"` (眠)
        - `"neutral"` (無)

### 3.3. 発話 (Speech)

指定されたテキストをTTSで読み上げます。

- **送信JSON例**:
```json
{"cmd": "say", "val": "こんにちは、スタックチャンです"}
```

- **パラメータ詳細**:
    - `cmd`: `"say"` (固定)
    - `val`: 発話させるテキスト (string)。UTF-8文字列。

## 4. エラーハンドリング・その他

- **コネクション維持**:
    - コントローラーアプリ起動時に接続を試み、終了時に切断します。
    - ロボット側は、クライアントからの切断を検知したら、次の再接続を待ち受ける状態に戻ってください。
- **パースエラー**:
    - 不正なJSONを受信した場合は無視してください。
